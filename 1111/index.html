<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Notes</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #1e1e1e;
            --card: #2d2d2d;
            --text: #e0e0e0;
            --accent: #00a8e8; /* Blu Supabase */
            --success: #28a745;
            --warning: #ffc107;
        }

        body {
            margin: 0; padding: 20px; font-family: 'Inter', sans-serif;
            background: var(--bg); color: var(--text);
            display: flex; flex-direction: column; align-items: center;
            height: 100vh; box-sizing: border-box;
        }

        .header {
            width: 100%; max-width: 800px; display: flex; 
            justify-content: space-between; align-items: center; margin-bottom: 15px;
        }
        
        .back-btn { 
            color: #888; text-decoration: none; font-size: 14px; 
            display: flex; align-items: center; gap: 5px; transition: color 0.3s;
        }
        .back-btn:hover { color: white; }

        .status-badge {
            font-size: 12px; font-weight: 600; padding: 4px 10px; border-radius: 20px;
            background: #333; color: #888; transition: all 0.3s;
            display: flex; align-items: center; gap: 6px;
        }
        
        /* Stati del salvataggio */
        .status-badge.saving { color: var(--warning); background: rgba(255, 193, 7, 0.1); }
        .status-badge.saved { color: var(--success); background: rgba(40, 167, 69, 0.1); }
        .status-badge.error { color: #dc3545; background: rgba(220, 53, 69, 0.1); }

        /* Area di testo */
        .editor-container {
            width: 100%; max-width: 800px; flex: 1; display: flex; flex-direction: column;
        }

        textarea {
            width: 100%; height: 100%;
            background: var(--card); color: var(--text);
            border: 1px solid #333; border-radius: 12px;
            padding: 25px; font-size: 16px; line-height: 1.6;
            font-family: 'Inter', sans-serif;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            resize: none; outline: none; transition: border-color 0.3s;
        }
        
        textarea:focus { border-color: #555; }
        
        /* Scrollbar carina */
        textarea::-webkit-scrollbar { width: 8px; }
        textarea::-webkit-scrollbar-track { background: var(--card); }
        textarea::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }

        @media (max-width: 600px) {
            body { padding: 15px; }
            textarea { font-size: 15px; padding: 15px; }
        }
    </style>
</head>
<body>

    <div class="header">
        <a href="/generale/" class="back-btn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
            Home
        </a>
        <div id="statusIndicator" class="status-badge">● Pronto</div>
    </div>

    <div class="editor-container">
        <textarea id="myNote" placeholder="Caricamento note dal cloud..."></textarea>
    </div>
    <script>
        // --- CONFIGURAZIONE ---
        // RIMETTI LE TUE CHIAVI QUI!
        const SUPABASE_URL = 'https://aibjrbhlrjqubxolaqsi.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFpYmpyYmhscmpxdWJ4b2xhcXNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNDg1MjgsImV4cCI6MjA3OTgyNDUyOH0.GNTtNcuosOR5UrXMXNJjGZ0zt0K_d5Tu18ONDy5ay1o';

        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        const noteArea = document.getElementById('myNote');
        const statusBadge = document.getElementById('statusIndicator');
        let saveTimeout;

        // 1. CARICAMENTO INIZIALE
        async function loadNotes() {
            setStatus('saving', 'Caricamento...');
            noteArea.disabled = true;

            const { data, error } = await _supabase
                .from('notes')
                .select('content')
                .eq('id', 1)
                .single();

            if (error) {
                console.error('Errore:', error);
                setStatus('error', 'Offline');
                noteArea.value = "Impossibile connettersi.";
            } else {
                noteArea.value = data.content || "";
                setStatus('saved', 'Pronto');
                noteArea.disabled = false;
            }
        }

        // 2. ATTIVAZIONE REALTIME (La Magia)
        function setupRealtime() {
            _supabase
                .channel('room1')
                .on(
                    'postgres_changes', 
                    { event: 'UPDATE', schema: 'public', table: 'notes', filter: 'id=eq.1' }, 
                    (payload) => {
                        // Quando arriva una modifica dal server...
                        const newText = payload.new.content;
                        
                        // Aggiorna SOLO se il testo è diverso da quello che vedo
                        // (Per evitare che il cursore salti se sto scrivendo io)
                        if (noteArea.value !== newText) {
                            noteArea.value = newText;
                            setStatus('saved', 'Aggiornato Live!');
                            
                            // Piccolo flash giallo per far notare il cambio
                            noteArea.style.backgroundColor = '#333';
                            setTimeout(() => { noteArea.style.backgroundColor = 'var(--card)'; }, 300);
                        }
                    }
                )
                .subscribe();
        }

        // 3. SALVATAGGIO CON DEBOUNCE
        noteArea.addEventListener('input', () => {
            setStatus('saving', 'Scrivendo...');
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
                saveToCloud(noteArea.value);
            }, 1000); // Salva dopo 1 secondo di pausa
        });

        async function saveToCloud(text) {
            const { error } = await _supabase
                .from('notes')
                .update({ content: text })
                .eq('id', 1);

            if (error) {
                console.error('Errore:', error);
                setStatus('error', 'Errore salvataggio');
            } else {
                setStatus('saved', 'Salvato');
            }
        }

        function setStatus(type, text) {
            statusBadge.className = 'status-badge ' + type;
            statusBadge.innerHTML = (type === 'saving' ? '⟳ ' : (type === 'saved' ? '✓ ' : '⚠ ')) + text;
        }

        // Avvio tutto
        window.onload = async function() {
            await loadNotes(); // Prima scarico i dati vecchi
            setupRealtime();   // Poi attivo l'ascolto per i nuovi
        };

    </script>
</body>
</html>
