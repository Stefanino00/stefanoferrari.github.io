<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Allenamento test - TSS</title>

<style>
  :root{ --bg:#dddddd; --card:#fff; --accent:#0b77f4; --ok:#1e9e4a; --ko:#d32f2f; }
  html,body{ height:100%; margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial; background:var(--bg); color:#111; }
  .wrap{ max-width:980px; margin:20px auto; padding:16px; }
  .card{ background:var(--card); border-radius:10px; box-shadow:0 6px 18px rgba(15,20,30,0.08); padding:16px; margin-bottom:14px; }
  h1{ margin:0 0 6px 0; font-size:18px; }
  .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  input[type=password], textarea{ width:100%; padding:10px; border-radius:8px; border:1px solid #ddd; font-size:15px; box-sizing:border-box; }
  button{ background:var(--accent); color:#fff; border:0; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:600; }
  button:active{ transform:scale(0.98); opacity:0.9; }
  button.secondary{ background:#f0f0f0; color:#111; }
  .hidden{ display:none; }
  #answers{ margin-top:12px; display:grid; gap:8px; grid-template-columns:1fr; min-height:80px; }
  .ans-btn{ padding:12px; text-align:left; border-radius:8px; border:2px solid #6b6b6b; background:#000000; cursor:pointer; font-size:15px; min-height:48px; font-weight:600; color:#fff; }
  .ans-btn[disabled]{ opacity:.6; cursor:not-allowed; }
  #feedback{ margin-top:12px; font-weight:700; }
  .small { font-size:13px; color:#555; }
  .correct { color:var(--ok); }
  .wrong { color:var(--ko); }
  .meta { display:flex; gap:8px; align-items:center; margin-top:8px; color:#666; font-size:13px; }
  .badge{ background:#eef6ff; color:var(--accent); padding:4px 8px; border-radius:999px; font-weight:700; }
  @media (max-width: 600px) {
    .wrap { margin: 10px auto; padding: 10px; }
    html, body { font-size: 17px; }
    .small { font-size: 14px; }
  }
</style>

<script src="domande.js"></script>

</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Accesso test</h1>
    <div class="small">Inserisci il codice per avviare il test</div>
    <div style="margin-top:10px;" class="row">
      <input id="accessCode" type="password" placeholder="Codice di accesso">
      <button id="btnLogin">Accedi</button>
      <button id="btnDemo" class="secondary" style="display:none">Demo</button>
    </div>
    <div id="loginMsg" class="small" style="color:#b00; margin-top:8px;"></div>
  </div>

  <div id="quizCard" class="card hidden">
    <div id="quizContent">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h1 id="questionTitle">Domanda</h1>
          <div class="small" id="qInfo">0 / 0</div>
        </div>
        <div>
          <div class="badge" id="scoreBadge">0/0</div>
        </div>
      </div>

      <div id="answers" style="margin-top:12px;"></div>

      <div id="feedback" class="small"></div>

      <div style="margin-top:12px;" class="row">
        <button id="nextBtn" class="hidden">Prossima domanda</button>
        <button id="endBtn" class="secondary hidden">Termina test</button>
        <button id="restartBtn" class="hidden secondary">Ricomincia</button>
        <button id="downloadBtn" class="hidden">Scarica risultato</button>
      </div>
    </div>

    <div class="meta">
      <div id="elapsed">Tempo: 0s</div>
      <div id="lastAction">Ultima azione: -</div>
    </div>
  </div>
</div>

<script>
/* ========== CONFIG ========== */
const ACCESS_CODE = "2005";

/* stato applicazione */
let order = [];
let idx = 0;
let correctCount = 0;
let totalAnswered = 0;
let startTime = null;
let timerInterval = null;

/* Login */
document.getElementById('btnLogin')?.addEventListener('click', () => {
  const code = document.getElementById('accessCode').value.trim();
  if(code === ACCESS_CODE){
    document.getElementById('loginMsg').textContent = '';
    startApp();
  } else {
    document.getElementById('loginMsg').textContent = 'Codice errato.';
  }
});
document.getElementById('btnDemo')?.addEventListener('click', startApp);

/* Avvio */
function startApp(){
  // Verifica che il file esterno sia caricato
  if(typeof domandeQuiz === 'undefined' || !domandeQuiz.length) {
    alert("Errore: Impossibile caricare le domande dal file domande.js");
    return;
  }

  document.querySelector('.card').classList.add('hidden'); // Nascondi login
  document.getElementById('quizCard').classList.remove('hidden');
  
  shuffleOrder();
  idx = 0; 
  correctCount = 0; 
  totalAnswered = 0;
  startTime = Date.now(); 
  startTimer();
  showQuestion();
}

/* Mescola ordine domande */
function shuffleArray(a){ 
    for(let i=a.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
    } 
}
function shuffleOrder(){ 
    order = domandeQuiz.map((_,i)=>i); 
    shuffleArray(order); 
}

/* Mostra domanda */
function showQuestion(){
  if(idx >= order.length){ endTest(); return; }
  
  const qIndex = order[idx];
  const q = domandeQuiz[qIndex];

  // Aggiorna UI
  document.getElementById('questionTitle').innerText = q.domanda;
  document.getElementById('qInfo').innerText = `${idx+1} / ${order.length}`;
  document.getElementById('feedback').innerText = '';
  document.getElementById('scoreBadge').innerText = `${correctCount}/${totalAnswered}`;
  document.getElementById('nextBtn').classList.add('hidden');
  document.getElementById('endBtn').classList.add('hidden');

  const answersDiv = document.getElementById('answers');
  answersDiv.innerHTML = '';

  // Genera pulsanti per le risposte A, B, C, D
  ['A', 'B', 'C', 'D'].forEach(letter => {
      if(q.risposte[letter]) {
          const btn = document.createElement('button');
          btn.className = 'ans-btn';
          btn.type = 'button';
          btn.textContent = `${letter}) ${q.risposte[letter]}`;
          btn.style.whiteSpace = 'pre-wrap';
          btn.style.wordBreak = 'break-word';
          
          // Click handler
          btn.addEventListener('click', () => handleAnswerClick(btn, letter, q.corretta, q));
          answersDiv.appendChild(btn);
      }
  });
}

/* Gestione click risposta */
function handleAnswerClick(button, selectedLetter, correctLetter, questionData){
  // Disabilita tutti i pulsanti
  const btns = Array.from(document.querySelectorAll('.ans-btn'));
  btns.forEach(b => b.disabled = true);

  const isCorrect = selectedLetter === correctLetter;
  totalAnswered++; 
  if(isCorrect) correctCount++;

  const fbEl = document.getElementById('feedback');
  
  if(isCorrect){
    fbEl.className = 'small correct';
    fbEl.innerText = 'CORRETTO ✓';
    button.style.borderColor = 'var(--ok)';
  } else {
    fbEl.className = 'small wrong';
    fbEl.innerText = `SBAGLIATO ✗ — La risposta corretta era la ${correctLetter}`;
    button.style.borderColor = 'var(--ko)';
  }

  document.getElementById('scoreBadge').innerText = `${correctCount}/${totalAnswered}`;
  document.getElementById('lastAction').innerText = `Ultima: ${isCorrect ? 'Corretta' : 'Errata'}`;

  // Mostra bottoni next/end
  if(idx < order.length - 1){ 
      document.getElementById('nextBtn').classList.remove('hidden'); 
      document.getElementById('endBtn').classList.remove('hidden'); 
  } else { 
      document.getElementById('endBtn').classList.remove('hidden'); 
  }
}

/* Navigazione */
document.getElementById('nextBtn')?.addEventListener('click', () => { idx++; showQuestion(); });
document.getElementById('endBtn')?.addEventListener('click', endTest);
document.getElementById('restartBtn')?.addEventListener('click', () => location.reload());

document.getElementById('downloadBtn')?.addEventListener('click', () => {
  const tot = totalAnswered;
  const perc = tot > 0 ? Math.round((correctCount / tot) * 100) : 0;
  const data = { total: tot, correct: correctCount, perc, timestamp: new Date().toISOString() };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'risultato_test.json'; a.click(); URL.revokeObjectURL(url);
});

/* Fine test */
function endTest(){
  stopTimer();
  const tot = totalAnswered;
  const perc = tot>0 ? Math.round((correctCount/tot)*100) : 0;
  const container = document.getElementById('quizContent');
  
  container.innerHTML = `
    <h1>Test completato</h1>
    <div style="margin: 20px 0; font-size: 18px;">
        Risposte totali: <strong>${tot}</strong><br>
        Corrette: <strong style="color:var(--ok)">${correctCount}</strong><br>
        Punteggio: <strong>${perc}%</strong>
    </div>
  `;
  
  document.getElementById('restartBtn')?.classList.remove('hidden');
  document.getElementById('downloadBtn')?.classList.remove('hidden');
}

/* Timer */
function startTimer(){ 
    const el = document.getElementById('elapsed'); 
    if(timerInterval) clearInterval(timerInterval); 
    timerInterval = setInterval(()=>{ 
        const s = Math.floor((Date.now()-startTime)/1000); 
        el.innerText = `Tempo: ${s}s`; 
    }, 1000); 
}
function stopTimer(){ 
    if(timerInterval) clearInterval(timerInterval); 
}
</script>
</body>
</html>
