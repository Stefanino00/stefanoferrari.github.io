<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Test lettura PDF Distinte</title>
<style>
  body { font-family: Arial; margin: 20px; }
  #login, #quiz, #risultato { margin-top: 20px; }
  #debug { border: 1px solid #ccc; padding: 10px; margin-top: 20px; height: 150px; overflow-y: scroll; background: #f9f9f9; }
  .risposta { margin: 5px 0; padding: 5px; cursor: pointer; border: 1px solid #ccc; border-radius: 5px; }
  .risposta:hover { background-color: #eee; }
  .corretta { background-color: #c8ffc8 !important; }
  .sbagliata { background-color: #ffc8c8 !important; }
</style>
</head>
<body>

<h1>Test lettura distinte</h1>

<div id="login">
  <label>Codice: <input type="text" id="codice"></label>
  <button id="btnLogin">Accedi</button>
</div>

<div id="quiz" style="display:none;">
  <div id="domandaAttuale"></div>
  <div id="risposte"></div>
  <button id="btnProssima" style="display:none;">Prossima</button>
</div>

<div id="debug">
  <strong>Debug:</strong><br>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.min.js"></script>
<script>
const debugDiv = document.getElementById('debug');
function logDebug(msg) {
  debugDiv.innerHTML += msg + "<br>";
  debugDiv.scrollTop = debugDiv.scrollHeight;
}

let domande = [];
let indiceDomanda = 0;

// Login
document.getElementById('btnLogin').addEventListener('click', () => {
  const codice = document.getElementById('codice').value;
  if (codice === '13112005') {
    logDebug("Accesso consentito!");
    document.getElementById('login').style.display = 'none';
    loadPDF();
  } else {
    alert('Codice errato');
    logDebug("Accesso negato per codice: " + codice);
  }
});

// Caricamento PDF
async function loadPDF() {
  const url = 'domandetest.pdf';
  logDebug(`Inizio caricamento PDF: ${url}`);

  const loadingTask = pdfjsLib.getDocument(url);
  const pdf = await loadingTask.promise;
  logDebug(`PDF caricato. Pagine: ${pdf.numPages}`);

  let testoCompleto = '';
  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const textContent = await page.getTextContent();
    const pageText = textContent.items.map(item => item.str).join(' ');
    testoCompleto += pageText + "\n";
    logDebug(`Pagina ${i} letta.`);
  }

  parseDomande(testoCompleto);
}

// Parsing domande
function parseDomande(testo) {
  let raw = testo.split('●').map(d => d.trim()).filter(d => d.length > 0);
  domande = raw.map(d => {
    const lines = d.split(/\r?\n/).map(l => l.trim()).filter(l => l);
    const domanda = lines.shift();
    const risposte = lines.slice(0,4).map(r => ({
      testo: r.replace(/^([A-D])\s*/, ''),
      lettera: r.match(/^([A-D])/)? r.match(/^([A-D])/)[1] : '',
      corretta: r.includes('●')
    }));
    return {domanda, risposte};
  });

  domande = domande.sort(() => Math.random() - 0.5);
  logDebug(`Numero domande: ${domande.length}`);
  mostraDomanda(indiceDomanda);
}

// Mostra domanda corrente
function mostraDomanda(idx) {
  if(idx >= domande.length){
    document.getElementById('quiz').innerHTML = `<h2>Hai completato il quiz!</h2>`;
    return;
  }
  const d = domande[idx];
  document.getElementById('domandaAttuale').innerHTML = `<strong>${d.domanda}</strong>`;
  const risposteDiv = document.getElementById('risposte');
  risposteDiv.innerHTML = '';
  d.risposte.forEach((r,i) => {
    const div = document.createElement('div');
    div.className = 'risposta';
    div.textContent = `${r.lettera}. ${r.testo}`;
    div.addEventListener('click', () => {
      const tutte = risposteDiv.querySelectorAll('.risposta');
      tutte.forEach(el => el.style.pointerEvents='none');
      if(r.corretta) div.classList.add('corretta');
      else div.classList.add('sbagliata');
      document.getElementById('btnProssima').style.display='inline-block';
    });
    risposteDiv.appendChild(div);
  });
  document.getElementById('btnProssima').style.display='none';
}

// Prossima domanda
document.getElementById('btnProssima').addEventListener('click', () => {
  indiceDomanda++;
  mostraDomanda(indiceDomanda);
});
</script>

</body>
</html>
