<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Simulazione Esame TSS</title>

<script src="domande.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<style>
  :root {
    --primary: #0056b3;
    --primary-light: #eef6ff;
    --accent: #00a8e8;
    --success: #28a745;
    --danger: #dc3545;
    --text: #212529;
    --text-muted: #6c757d;
    --bg: #f4f6f8;
    --card-bg: #ffffff;
    --radius: 16px;
    --shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
    --border: #eef0f2;
  }

  body.dark-mode {
    --primary: #4dabf7;
    --primary-light: #1a2636;
    --accent: #3bc9db;
    --success: #40c057;
    --danger: #fa5252;
    --text: #e9ecef;
    --text-muted: #adb5bd;
    --bg: #121212;
    --card-bg: #1e1e1e;
    --shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
    --border: #2c2e33;
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body {
    margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text);
    min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 20px;
    transition: background 0.3s, color 0.3s;
  }

  .container { width: 100%; max-width: 600px; margin: auto; position: relative; }

  .theme-toggle {
    position: absolute; top: -50px; right: 0; background: none; border: none;
    color: var(--text-muted); cursor: pointer; font-size: 24px;
  }

  .card {
    background: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow);
    padding: 24px; margin-bottom: 20px; text-align: center; transition: background 0.3s;
  }

  h1 { margin: 0 0 10px 0; font-size: 22px; color: var(--primary); font-weight: 800; }
  p { margin: 0 0 20px 0; color: var(--text-muted); font-size: 15px; line-height: 1.5; }

  /* NAVIGAZIONE PALLINI SCORREVOLE */
  .nav-dots-wrapper {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    margin-bottom: 25px; padding: 10px; background: var(--bg); border-radius: 12px;
    height: 70px; 
  }
  
  .nav-dots-container {
    display: flex; gap: 8px; justify-content: center; align-items: center;
  }

  .nav-dot {
    width: 10px; height: 10px; border-radius: 50%; background: var(--text-muted);
    opacity: 0.2; cursor: default; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    transform: scale(0.8);
  }
  
  .nav-dot.active { 
    width: 14px; height: 14px; opacity: 1; 
    border: 2px solid var(--text); transform: scale(1.2); 
    z-index: 2;
  }
  
  .nav-dot.filled { background: var(--primary); opacity: 0.7; }
  .nav-dot.correct { background: var(--success); opacity: 0.7; }
  .nav-dot.wrong { background: var(--danger); opacity: 0.7; }

  .nav-dot.active.filled { background: var(--primary); opacity: 1; border-color: var(--primary); }
  .nav-dot.active.correct { background: var(--success); opacity: 1; border-color: var(--success); }
  .nav-dot.active.wrong { background: var(--danger); opacity: 1; border-color: var(--danger); }

  .nav-counter {
    font-size: 11px; font-weight: 700; color: var(--text-muted);
    margin-top: 8px; letter-spacing: 1px; font-family: monospace;
  }

  .stats-grid {
    display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px;
    background: var(--primary-light); padding: 15px; border-radius: 12px;
    margin-bottom: 20px; margin-top: 10px;
  }
  .stat-item { display: flex; flex-direction: column; align-items: center; }
  .stat-val { font-size: 18px; font-weight: 800; color: var(--primary); white-space: nowrap;}
  .stat-lbl { font-size: 10px; text-transform: uppercase; color: var(--text-muted); margin-top: 4px; font-weight: 600; }

  input[type=password] {
    width: 100%; padding: 14px; border-radius: 12px; border: 2px solid var(--border);
    background: var(--bg); color: var(--text); font-size: 16px; margin-bottom: 15px;
    outline: none; text-align: center;
  }
  input:focus { border-color: var(--accent); }

  .btn {
    width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 16px;
    font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center;
    gap: 10px; transition: transform 0.1s;
  }
  .btn:active { transform: scale(0.98); }
  .btn-primary { background: var(--primary); color: #fff; }
  .btn-secondary { background: transparent; border: 2px solid var(--border); color: var(--text); margin-top: 12px; }
  .btn-warning { background: #fff3cd; color: #856404; margin-top: 12px; border: 1px solid #ffeeba; }

  .btn-option {
    background: var(--card-bg); border: 2px solid var(--border); color: var(--text);
    text-align: left; justify-content: flex-start; padding: 18px; margin-bottom: 12px;
    font-weight: 500; line-height: 1.4; cursor: pointer; width: 100%; border-radius: 10px;
  }
  .btn-option.selected { border-color: var(--primary); background: var(--primary-light); color: var(--primary); font-weight: 700; }
  .btn-option.correct { border-color: var(--success); background: rgba(40, 167, 69, 0.1); color: var(--success); }
  .btn-option.wrong { border-color: var(--danger); background: rgba(220, 53, 69, 0.1); color: var(--danger); }

  .review-option {
    padding: 12px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 6px;
    font-size: 14px; display: flex; justify-content: space-between; align-items: center;
    background: var(--card-bg); color: var(--text-muted);
  }
  .review-correct { border-color: var(--success); background: rgba(40, 167, 69, 0.15); color: var(--success); font-weight: 600; }
  .review-wrong { border-color: var(--danger); background: rgba(220, 53, 69, 0.15); color: var(--danger); font-weight: 600; }
  .review-neutral { opacity: 0.7; }

  .exit-btn { background: none; border: none; color: var(--text-muted); font-size: 24px; cursor: pointer; padding: 0 10px; }
  
  .badge { padding: 6px 12px; border-radius: 30px; font-size: 12px; font-weight: 800; letter-spacing: 0.5px; }
  .badge-info { background: var(--primary-light); color: var(--primary); }
  .badge-warn { background: #fff3cd; color: #856404; }

  .result-box { padding: 25px; border-radius: var(--radius); margin-bottom: 25px; }
  .pass { background: rgba(40, 167, 69, 0.1); color: var(--success); border: 1px solid var(--success); }
  .fail { background: rgba(220, 53, 69, 0.1); color: var(--danger); border: 1px solid var(--danger); }
  .score-big { font-size: 48px; font-weight: 900; margin: 10px 0; }

  .hidden { display: none !important; }
  .fade-in { animation: fadeIn 0.4s ease; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>

<div class="container">
   
  <button class="theme-toggle" onclick="toggleTheme()">üåó</button>

  <div id="loginCard" class="card fade-in">
    <div style="margin-bottom: 20px;">
      <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="var(--primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg>
    </div>
    <h1>Training TSS</h1>
    <p>Inserisci il codice per accedere.</p>
    <input id="accessCode" type="password" placeholder="Codice Accesso" inputmode="numeric">
    <button id="btnLogin" class="btn btn-primary">Accedi</button>
    <div id="loginMsg" style="color:var(--danger); margin-top:15px; font-size:14px; font-weight:600;"></div>
  </div>

  <div id="menuCard" class="card hidden fade-in">
    <h1>Benvenuto</h1>
    
    <div id="statsBox" class="hidden">
      <div class="stats-grid">
        <div class="stat-item">
          <div id="statTotal" class="stat-val">0</div>
          <div class="stat-lbl">Esami</div>
        </div>
        <div class="stat-item">
          <div id="statPassed" class="stat-val" style="color:var(--success)">0</div>
          <div class="stat-lbl">Passati</div>
        </div>
        <div class="stat-item">
          <div id="statBest" class="stat-val" style="color:var(--accent)">0%</div>
          <div class="stat-lbl">Record</div>
        </div>
        <div class="stat-item">
          <div id="statSpeed" class="stat-val" style="color:#e83e8c; font-family:monospace; font-size:16px;">--:--</div>
          <div class="stat-lbl">Best Time</div>
        </div>
      </div>
    </div>

    <p>Scegli una modalit√†:</p>
    
    <button onclick="startSimulation()" class="btn btn-primary">
      Simulazione Esame
    </button>
    <p style="font-size:12px; margin-top:8px; color:var(--text-muted);">
      20 Domande ‚Ä¢ Navigazione Libera ‚Ä¢ Esito finale<br>
      <strong>Superamento al 75%</strong>
    </p>

    <button onclick="startPractice()" class="btn btn-secondary">
      Esercitazione Libera
    </button>
    <p style="font-size:12px; margin-top:8px; color:var(--text-muted);">Tutte le domande ‚Ä¢ Feedback immediato</p>

    <button onclick="startReview()" class="btn btn-warning">
      ‚ö†Ô∏è Ripasso Errori
    </button>
    <p style="font-size:12px; margin-top:8px; color:var(--text-muted);">Rifai solo le domande sbagliate in passato</p>
  </div>

  <div id="quizCard" class="card hidden" style="text-align: left;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
      <button class="exit-btn" onclick="goToMenu()">‚úï</button>
      
      <span id="modeLabel" class="badge badge-info">SIMULAZIONE</span>
      <span id="timer" style="font-family:monospace; font-weight:700; font-size:16px; color:var(--text-muted);">00:00</span>
    </div>

    <div class="nav-dots-wrapper">
        <div id="navDots" class="nav-dots-container"></div>
        <div id="navCounter" class="nav-counter"></div>
    </div>

    <h2 id="questionText" style="font-size:19px; line-height:1.5; margin-bottom:25px; font-weight:700;">Caricamento...</h2>

    <div id="answersContainer"></div>

    <div style="margin-top:25px; display:flex; gap:10px;">
        <button id="prevBtn" class="btn btn-secondary hidden" style="margin-top:0; flex:1;">Indietro</button>
        <button id="nextBtn" class="btn btn-primary hidden" style="flex:2;">Avanti</button>
        <button id="endBtn" class="btn btn-primary hidden" style="background:var(--text-muted); flex:2;">Consegna</button>
    </div>
  </div>

  <div id="resultCard" class="card hidden fade-in">
    <h1 id="resultTitle">Esito Esame</h1>
    
    <div id="resultBox" class="result-box">
      <div style="font-size:13px; text-transform:uppercase; letter-spacing:1px; font-weight:700; opacity:0.8;">Punteggio Finale</div>
      <div id="scoreBig" class="score-big">0%</div>
      <div id="scoreText" style="font-weight:600;">0 su 20</div>
      <div id="timeTaken" style="font-size:14px; margin-top:5px; color:var(--text-muted); font-family:monospace;"></div>
    </div>

    <p id="resultMessage" style="font-weight:500;">Messaggio</p>

    <button onclick="goToMenu()" class="btn btn-primary">Torna al Menu</button>
    
    <div id="reviewSection" class="hidden" style="margin-top:30px; text-align:left;">
      <h3 style="font-size:16px; color:var(--danger); margin-bottom:15px;">Riepilogo Errori Sessione:</h3>
      <div id="errorList"></div>
    </div>
  </div>

</div>

<script>
const ACCESS_CODE = "2005";
const STATS_KEY = 'tss_stats_v2'; 
const ERROR_KEY = 'tss_errors_v1';

let currentMode = ''; 
let questionSet = [];
let currentIndex = 0;
let userAnswers = []; 
let startTime;
let timerInterval;

window.addEventListener('load', () => {
  if(sessionStorage.getItem('isLoggedIn') === 'true') {
    showMenu();
  }
});

document.getElementById('btnLogin').addEventListener('click', () => {
  const input = document.getElementById('accessCode').value;
  if(input === ACCESS_CODE) {
    sessionStorage.setItem('isLoggedIn', 'true');
    showMenu();
  } else {
    document.getElementById('loginMsg').innerText = "Codice errato.";
    vibrate(200);
  }
});

function showMenu() {
  document.getElementById('loginCard').classList.add('hidden');
  document.getElementById('resultCard').classList.add('hidden');
  document.getElementById('quizCard').classList.add('hidden');
  document.getElementById('menuCard').classList.remove('hidden');
  loadStats();
}

function goToMenu() {
  clearInterval(timerInterval);
  userAnswers = [];
  currentIndex = 0;
  showMenu();
}

function toggleTheme() {
  document.body.classList.toggle('dark-mode');
}

function loadStats() {
  const data = localStorage.getItem(STATS_KEY);
  if(data) {
    const stats = JSON.parse(data);
    if(stats.total > 0) {
      document.getElementById('statsBox').classList.remove('hidden');
      document.getElementById('statTotal').innerText = stats.total;
      document.getElementById('statPassed').innerText = stats.passed;
      document.getElementById('statBest').innerText = stats.best + "%";
      if(stats.bestTime && stats.bestTime > 0) {
         document.getElementById('statSpeed').innerText = formatTime(stats.bestTime);
      } else {
         document.getElementById('statSpeed').innerText = "--:--";
      }
    }
  }
}

function saveStats(percentage, passed, timeInSeconds) {
  let stats = { total: 0, passed: 0, best: 0, bestTime: 0 };
  const data = localStorage.getItem(STATS_KEY);
  if(data) stats = JSON.parse(data);

  stats.total++;
  if(passed) stats.passed++;
  if(percentage > stats.best) stats.best = percentage;

  if(percentage === 100) {
      if(stats.bestTime === 0 || timeInSeconds < stats.bestTime) {
          stats.bestTime = timeInSeconds;
      }
  }

  localStorage.setItem(STATS_KEY, JSON.stringify(stats));
}

function trackError(questionId) {
  let errors = JSON.parse(localStorage.getItem(ERROR_KEY)) || {};
  errors[questionId] = (errors[questionId] || 0) + 1;
  localStorage.setItem(ERROR_KEY, JSON.stringify(errors));
}

function checkDatabase() {
  if(typeof domandeQuiz === 'undefined') { alert("Errore: domande.js non trovato"); return false; }
  return true;
}

function startSimulation() {
  if(!checkDatabase()) return;
  currentMode = 'simulation';
  let
