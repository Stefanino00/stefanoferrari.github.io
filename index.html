<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Esame CEFRA</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.146/pdf.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  #loginDiv, #mainDiv { margin-bottom: 20px; }
  #debug { background: #f0f0f0; padding: 10px; margin-top: 10px; max-height: 300px; overflow-y: scroll; font-size: 12px; }
  .question { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; border-radius: 5px; }
</style>
</head>
<body>

<div id="loginDiv">
  <h2>Accesso Esame.</h2>
  <input type="password" id="codeInput" placeholder="Inserisci codice">
  <button onclick="checkCode()">Accedi</button>
</div>

<div id="mainDiv" style="display:none;">
  <h2>Domande Esame</h2>
  <div id="questionsDiv"></div>
</div>

<h3>Debug</h3>
<div id="debug"></div>

<script>
const correctCode = "13112005";
const debugDiv = document.getElementById("debug");

function logDebug(msg) {
  debugDiv.innerHTML += msg + "<br>";
}

function checkCode() {
  const input = document.getElementById("codeInput").value;
  if(input === correctCode){
    logDebug("Accesso consentito!");
    document.getElementById("loginDiv").style.display = "none";
    document.getElementById("mainDiv").style.display = "block";
    loadPDF();
  } else {
    alert("Codice errato!");
  }
}

async function loadPDF() {
  const url = 'domandetest.pdf';
  logDebug("Inizio caricamento PDF: " + url);
  
  const loadingTask = pdfjsLib.getDocument(url);
  const pdf = await loadingTask.promise;
  logDebug(`PDF caricato con successo. Numero pagine: ${pdf.numPages}`);
  
  let fullText = "";
  for(let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const textContent = await page.getTextContent();
    const pageText = textContent.items.map(item => item.str).join(" ");
    logDebug(`Lettura pagina: ${i}`);
    fullText += pageText + "\n";
  }

  logDebug("PDF letto completamente. Inizio estrazione domande...");
  const questions = extractQuestions(fullText);
  logDebug(`Numero domande totali: ${questions.length}`);

  shuffleArray(questions);
  displayQuestions(questions);
}

// Estrazione domande ignorando i pallini
function extractQuestions(text) {
  const questions = [];
  // Divido in blocchi basati su pattern maiuscolo + ?
  const regex = /([A-ZÀ-Ü ,.'’\-\(\)]+?\?)([^A-Z]*)((?:A\s.*?B\s.*?C\s.*?D\s.*?)/gs;
  let match;
  while((match = regex.exec(text)) !== null) {
    let questionText = match[1].trim();
    let optionsText = match[3].trim();
    const options = {};
    optionsText.split(/[A-D]\s/).slice(1).forEach((o, i)=>{
      options[String.fromCharCode(65+i)] = o.trim();
    });
    questions.push({question: questionText, options: options});
  }
  return questions;
}

// Mischio le domande
function shuffleArray(array) {
  for(let i = array.length -1; i >0; i--){
    const j = Math.floor(Math.random() * (i +1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

// Mostro le domande sul sito
function displayQuestions(questions) {
  const container = document.getElementById("questionsDiv");
  container.innerHTML = "";
  questions.forEach((q, idx) => {
    const div = document.createElement("div");
    div.className = "question";
    let html = `<strong>Domanda ${idx+1}:</strong> ${q.question}<br>`;
    for(const key in q.options){
      html += `<strong>${key}:</strong> ${q.options[key]}<br>`;
    }
    div.innerHTML = html;
    container.appendChild(div);
  });
  logDebug("Domande mostrate sul sito.");
}
</script>

</body>
</html>
